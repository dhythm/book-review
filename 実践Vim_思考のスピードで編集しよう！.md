# はじめに

「[実践 Vim 　思考のスピードで編集しよう！](https://www.amazon.co.jp/dp/B00HWLJI3U/)」のまとめです。

私は、学生時代は mi エディタに emacs キーバインドを組み込んで利用していました。  
社会人の一年目に会社の同期から薦められて Vim をメインで利用するようになり、習得のために議事録などの業務でも積極的に Vim を使うように試みました。

そんな時に出会ったのがこの本です。  
この本には数多くのテクニックが紹介されており、Vim 初心者だった私の Vim スキルを上げるために非常に役立つものでした。

# TL;DR

- Vim の基本はノーマルモード。手が止まったらインサートモードから抜けること。
- 繰り返す作業の単位を意識し、活用する。
- バッファが便利。まずは使って慣れてみる。
- 最初から完璧を目指さない。徐々にリファクタリングしていく。
- `mm`と`qq`が便利。
- ファイル全体にコマンドを実行する場合はグローバルコマンドを使う。

# 本書の内容

### 第１章 Vim のやり方

Vim の基礎となる考え方について触れている章です。  
この章ではテクニックよりも、概念や考え方を学ぶ意味合いが強いと感じました。

- Tips1: ドットコマンドとは
- Tips2: Don't Repeat Yourself
- Tips3: 一歩下がって、三歩進む
- Tips4: 実行して、繰り返して、元に戻す

ドットコマンドは、直前におこなった変更をもう一度繰り返せるマイクロマクロとも呼べる機能です。  
再利用可能な単位での変更を心がけることで、ドットコマンドは強力な機能に変化します。

例えば同じ作業を連続した行に実施する場合、「数字＋コマンド」(`N{cmd}`)で実現することができます。  
しかし本書では「移動＋コマンド」(`j.`)の組み合わせが推奨されています。  
これは、何回実施するかを考える必要がなくなるため、直感的に作業が実施できるためです。  
もし仮に多くキーを叩きすぎたとしても、アンドゥ(`u`)で変更を戻すことが可能です。

- Tips5: 手作業での検索と置換

カーソル上にある _word_ に対して`*`コマンドで単語検索ができます。(`/\<{word}\>`と同じ)  
`/`による検索コマンドは`n`で繰り返せるので、検索内容に対して{action}を繰り返し実行(`n.n.n.`)することが可能です。

- Tips6: ドットの公式

本書では「移動にキー入力１回、何かするのにキー入力１回」をドットの公式と呼んでいます。  
Vim は繰り返し作業に強いため、再利用できる変更をいかに上手く使いこなすかが作業高速化の鍵となることを学びました。

## 第１部 モード

### 第２章 ノーマルモード

この本を読むまでは他のテキストエディタのように、挿入モードで過ごす時間がほとんどでした。  
この章では「なぜ Vim にはノーマルモードが存在するのか」が説明されているので、モードに対する考え方を改めるきっかけとなりました。

- Tips7: 埃を払って一息つこう

Vim のモードを、画家とアトリエに例えているのがおもしろいです。  
ノーマルモードというのは平時の状態で、いつでも動き出せる状態として紹介されています。

- Tips8: アンドゥはひとまとめに

「手が止まるのであれば挿入モードから抜けるようにしよう。」  
この言葉からも、挿入モードに滞在する時間は短く、Vim の大半の時間はノーマルモードで過ごすものだと実感させられます。

挿入モードでカーソルキー(`<Up>`,`<Down>`,`<Left>`,`<Right>`)を使うとアンドゥの単位が新規に作られる、ということは知りませんでした。

- Tips10: 回数指定を使って簡単な計算を行う

`<Ctrl-a>`と`<Ctrl-x>`の使い方が記載されています。  
加算/減算自体の機能も便利ですが、自動でカーソルが数字上まで移動してくれる機能も非常に便利です。

- Tips11: 繰り返しで済むなら、回数を指定しない

回数を指定すると、作業に対してキーストロークの数を減らすことができます。  
しかし前にも記載したとおり、実際にはドットコマンドとアンドゥを活用したほうが便利です。  
回数を使うのは、「回数が重要なとき」だけに留めるべきだと書かれています。

- Tips12: 統合して統治せよ

Vim の基本機能である operator + motion = action について記載されています。  
「オペレータコマンドを連続入力すると、現在行への適用」になります。(`dd`や`>>`など。)

Vim にはオペレータ待機モードというモードがあることを知りました。  
例として、`g`や`z`、`<Ctrl-w>`、`[`があります。

### 第３章 挿入モード

挿入モードでの編集中にちょっとした修正をする場合、他のテキストエディタ同様`<Backspace>`やカーソルキーを利用していました。  
本章では、そのようなキーに頼る必要がなくなるテクニックが紹介されています。

- Tips13: 挿入モードで簡単修正
- Tips14: ノーマルモードへの復帰

挿入モードのまま作業を続けるためのテクニックとして、`<Backspace>`よりも高速に文字の修正が可能な、`<Ctrl-h>`,`<Ctrl-w>`,`<Ctrl-u>`があります。

コマンドを１つだけ実行してまた挿入モードに戻ってくる **挿入ノーマルモード** (`<Ctrl-o>`で切替)は、思考を中断することなく作業を継続できるのでおすすめです。

- Tips15: 挿入モードから抜けないでレジスタから貼り付け
- Tips16: 簡単な計算をその場で実行

`<Ctrl-r>{register}`や`<Ctrl-r><Ctrl-p>{register}`によるペースト機能は、挿入モードのまま利用できるので便利です。

`<Ctrl-r>=`を用いることで計算結果の貼り付けることができます。

- Tips17: 文字コードを使って特殊文字を入力

置換処理で、タブ文字や改行文字を出力したい場合が存在します。  
そんなとき、`<Ctrl-v>{code}`を覚えておくと便利です。

### 第４章 ビジュアルモード

Vim は行方向の編集には強力ですが、列方向の処理はそこまでです。  
ここで紹介されている矩形選択(ブロック指向のビジュアルモード)は、列方向の処理をサポートする機能です。  
あとで紹介されているコマンドラインモードと組み合わせることで、非常に強力なツールとなることを知りました。

- Tips21: ビジュアルな選択範囲の定義

ビジュアルモードで`o`キーを使うと、始点と終点をトグルすることができます。  
選択範囲を間違えた場合でも、ノーマルモードに戻ってやり直す必要がないので非常に便利な機能です。

- Tips22: 行指向のビジュアルモードコマンドを繰り返す

ここでも以前に紹介した繰り返しテクニックが紹介されています。  
ビジュアルモードで選択した範囲のインデントを 2 レベル深くする場合、`2>`で実現可能ですが`>.`でも同じことが実現できます。  
後者のほうが`.`や`u`が利用できるので、汎用性が高くなります。

- Tips23: 可能ならばビジュアルコマンドではなくオペレータを優先しよう

非常にわかりやすい例が挙げられていて参考になりました。

```html
<a href="#">one</a>
<a href="#">two</a>
<a href="#">three</a>
```

ビジュアルオペレータ`vit`で選択して`u`で大文字変換をおこない、その後`j.`で繰り返し処理をした場合、

```html
<a href="#">ONE</a>
<a href="#">TWO</a>
<a href="#">THRee</a>
```

となります。このようなケースの場合はビジュアルモードより、ノーマルモードのほうが適切に処理できます。  
ノーマルオペレータ`gUit`で大文字変換をおこなうと、`j.`が正しく動作することが確認できます。

```html
<a href="#">ONE</a>
<a href="#">TWO</a>
<a href="#">THREE</a>
```

ここでは、 **ドットコマンドをセットアップしようとする場合は、ビジュアルコマンドよりも等価な機能のノーマルオペレータコマンドで実現すべき** ということを学びました。  
Vim では目的を実現するための方法が複数用意されているので、ケースバイケースで機能を使い分けることが重要だと思います。

### 第５章 コマンドラインモード

行指向の操作に対してはコマンドラインモード(`:`キーで切替)が便利だということを学べます。  
飛び道具とも言える、編集作業に必要なテクニックが多く紹介されています。

- Tips27: Vim のコマンドラインモード
- Tips28: 連続する行に対してコマンドを実行する

「Ex コマンドの射程は広範囲」という言葉が特に心に残りました。

アドレスとして行番号を指定したり、選択範囲を使って行範囲を指定することができることは知っていましたが、パターンで行範囲を指定する機能やオフセットを使ったアドレス修正は初めて知りました。

##### パターンによる行指定の例

```
:/<html>/,/<\/html>/p
```

##### オフセットを使ったアドレス修正の例

```
:.,.+3p
```

- Tips29: 「:t」／「:m」コマンドで行をコピー／移動
- Tips31: 直前の Ex コマンドを繰り返す

`:t`と`:m`の存在を初めて知りました。  
本書では、ファイルの最後に移動したい領域をビジュアルモードで選択し、`:'<,'>m$`で移動するテクニックが紹介されています。

`@{register}`でレジスタの内容を実行します。(詳細は第１１章で説明)  
`@:`で直前の Ex コマンドを繰り返し利用することが可能です。  
二回目以降は、`@@`コマンドでさらに高速化することができます。

- Tips30: 選択範囲に対してノーマルモードのコマンドを実行する

ノーマルコマンドが持つ高い記述性と、Ex コマンドが持つ長射程を組み合わせて利用することができる非常に便利な機能です。  
筆者は`:normal .`か`:normal @q`で繰り返しコマンドと組み合わせて使うのが最強だと悟った、と述べています。  
「指定したノーマルモードコマンドを各行に対して実行する前に、カーソルをその行の先頭に移動する」という隠れた処理についても触れられています。

- Tips32: Ex コマンドでタブ補完
- Tips33: カーソル位置にある単語をコマンドプロンプトに挿入
- Tips34: 履歴からコマンドを呼び戻す

コマンドラインをより便利にするテクニックを知ることができました。

`<Ctrl-d>`による補完、`<Ctrl-r><Ctrl-w>`でカーソルの単語をコマンドラインに挿入する機能が紹介されています。

コマンド履歴を利用する際の`<Up>`/`<Down>`と`<Ctrl-p>`/`<Ctrl-n>`の違いは初めて知りました。  
本書にあるように、キーマッピングを下記のように設定しておくと便利です。

```vimrc
cnoremap <C-p> <Up>
cnoremap <C-n> <Down>
```

## 第２部 ファイル

### 第６章 複数ファイルの管理

この章ではバッファリストと引数リスト、分割スペース、タブページについて紹介されています。  
それぞれを適切に使い分けることで、作業効率が格段に上昇すると感じます。

- Tips36: バッファリストを使ってオープン中のファイルを管理する
- Tips38: 隠しファイルの管理

Vim では、バッファに対して操作をおこない、変更を保存するタイミングでバッファの内容をファイルへと書き出します。  
バッファを利用するためのコマンドは下記になります。

| コマンド         | 機能                                                           |
| :--------------- | :------------------------------------------------------------- |
| `:ls`            | バッファリストを確認                                           |
| `:b {bufname}/N` | 指定のバッファに移動                                           |
| `:bf/:bl`        | 最初／最後のバッファに移動                                     |
| `:bp/:bn`        | 前／次のバッファに移動                                         |
| `:bd`            | バッファリストから削除(完全には削除されず、`:ls!`で表示される) |
| `:bw`            | バッファから削除(バッファに関する全てが失われる)               |

デフォルトでは、バッファを切り替える際に編集中ファイルを保存していなくてもエラーとなります。  
下記の設定をしておくと、ファイル保存をしていなくても別のバッファに切り替えることができるので便利です。

```
:set hidden
```

本書に記載があるわけではないのですが、`:q`はウィンドウを閉じるコマンドなのでバッファには残ります。  
ウィンドウ本体が残っている場合には`:ls`で表示されるので、再度開くことができます。

- Tips39: ワークスペースを分割ウィンドウにする
- Tips40: タブページを使ってウィンドウのレイアウトを管理

分割ウィンドウの操作についての説明です。

内容を比較する場合は、垂直分割が便利です。  
同じファイルで比較する場合は`<Ctrl-w>v`か`:vsp`、違うファイルの場合は`:vnew [file]`を利用します。  
`:set sc[roll]b[ind]`で縦スクロールが同期されるので重宝しています。

複数ファイルを並行して編集する場合は水平分割がおすすめです。  
これは、Vim は行に対する処理に強いエディタであるため、横方向の視認性を落とさないほうが効率的だからです。  
本書では`<Ctrl-w>s`や`:sp`コマンドで現在のバッファをコピーする方法が紹介されていますが、個人的には`<Ctrl-w>n`や`:new [file]`で無名バッファを作成する方が好みです。

また、本書ではタブページの使い方についても記載されています。  
タブページは、現在実施している作業と完全に別の作業をおこなう場合に利用するための機能だと考えています。

### 第７章 ファイルのオープンとディスクへの保存

特筆するほどの内容ではありませんでしたが、Tips44 はバッファとファイルと概念を理解する上で勉強になりました。

- Tips43: netrw でファイルシステムを探索

vimrc に下記の記載を追加することで、Vim 同梱の netrw が利用できると書かれています。

```vimrc
set nocompatible
filetype plugin on
```

ここで紹介されているファイルエクスプローラー(`:e .`,`:E`)は、ディレクトリ構成を確認しながらファイルを探せるのでよく利用している機能です。

- Tips44: 存在していないディレクトリにファイルを保存

Vim では、存在していないディレクトリをパスに含んでいるバッファは編集が可能です。しかしファイルに書き込もうとした際にエラーが発生します。  
ここでは、外部コマンド(`:!mkdir -p %:h`)を利用した解決策が紹介されています。  
※ただし外部アプリケーションの Vim(MacVim 等)で実施できるかは環境に依るかもしれません。

## 第３部 スピードアップ！

### 第８章 モーションによるファイル内の移動

この章では、カーソル移動に関するテクニックが記載されています。  
普段から Vim を利用していても知らなかった内容もいくつかあり、非常に参考になりました。

- Tips46: 自分の指はホームポジションから外さない
- Tips48: 単語単位での移動
- Tips49: 文字を検索

横の移動に関する Tips が記載されています。  
**１行のなかで`h`キーを３回以上叩いているのなら、それはキーストロークを無駄遣いしている** という言葉が印象的です。  
横の移動は単語単位(`w`,`b`,`e`)、`f`/`t`や`^`/`$`を利用すべきと実感しました。  
`f`/`t`は`;`で繰り返すことができます。目的の場所を通りすぎた場合でも`,`で戻れるので安心です。  
ただし、日本語入力の際は`f`/`t`(単語単位の移動も)が役に立ちにくいのが残念なところです。

なお、本書には記載ありませんが、`_`は`^`と同じ効果があるようです。  
`<Shift>`キーはそれほど押しにくくはないので、JIS キーボードだと`^`よりも便利かもしれません。

- Tips47: 論理行と表示行を区別しよう
- Tips50: 検索して移動
- Tips53: 場所をマークして、そこにサッと戻る

縦方向の移動に関する Tips が記載されています。

マーク`m{letter}`の機能はあまり使いこなせていませんが、`mm`と`` `m``の組み合わせが便利なので使ってみたいと思います。  
別の行を参照／修正した後、戻ってきて作業を継続したい場合に重宝する機能です。

- Tips51: 高精度なテキストオブジェクトを使って選択範囲をトレース
- Tips52: デリミタを含めて削除したり、デリミタの内側を変更したり

デリミタ区切りのテキストオブジェクト機能である、`i{delimiter}`と`a{delimiter}`は非常に便利です。  
「"sample"」というテキスト上にカーソルがある場合、`di"`を押すと _sample_ という文字だけを削除して「""」が残ります。`da"`を押すと、ダブルクォーテーション(")ごと削除することができます。  
`a)`が`ab`に、`a}`が`aB`で代替可能というのも初めて知りました。

テキストオブジェクトにはもう１つ、単語／文／段落を区切りの対象としたものもあります。  
`d{motion}`は`aw`,`as`,`ap`と相性がよく、`c{motion}`は`iw`,`is`,`ip`と相性がよいと書かれています。

### 第９章 ジャンプによるファイル間の移動

モーションがファイル内の移動に適した機能とすれば、ジャンプはファイル間の移動に適した機能です。  
私もほとんど使ったことがなかったので、新たな発見が多い章でした。

- Tips55: ジャンプリストの移動
- Tips56: 変更リストを辿る
- Tips58: グローバルマークを使ってファイル感をテキパキと移動する

ジャンプリストは`<Ctrl-o>`,`<Ctrl-i>`で前後に辿ることができます。変更リストは`g;`と`g,`で前後に辿れます。  
ジャンプリスト／変更リストは、それぞれ以下のコマンドで開くことができます。

```
:jumps
```

```
:changes
```

`m{letter}`コマンドの _letter_ に大文字を使うとグローバルマークが作られ、別のファイルからでも一発で戻ってくることができます。

本書では、`:grep`,`:vimgrep`,`:make`,`:args {arglist}`,`:argdo`などを利用する際に、グローバルマークを設定するクセをつけることを推薦しています。

## 第４部 レジスタ

### 第１０章 コピー＆ペースト

レジスタの概念を非常に丁寧に説明されています。第４部は、私にとって最も勉強になった内容です。

- Tips60: Vim のレジスタを掌握する

コマンドに`"{register}`を前置き(`"+p`等)することで使いたいレジスタを指定できます。  
代表的なレジスタを以下に記載します。

| レジスタ | 内容                                                                   |
| :------: | :--------------------------------------------------------------------- |
|    ""    | 無名レジスタ。各コマンドにおいてデフォルトで利用される。               |
|    "0    | ヤンクレジスタ。`y{motion}`で値が設定される。                          |
| "a ～"z  | 名前付きレジスタ。大文字を使うと、設定されているレジスタに追記が可能。 |
|   "\_    | ブラックホールレジスタ。別名、消去専用レジスタ。                       |
|    "+    | システムクリップボードレジスタ。                                       |
|   "\*    | 選択範囲レジスタ。MacOS/Windows では"+レジスタと同じものとして使える。 |
|    "=    | Expression レジスタ。                                                  |
|    "%    | 現在の編集中のファイル名。                                             |
|    "#    | 代替ファイルのファイル名。                                             |
|    ".    | 直前に挿入されたテキスト。                                             |
|    ":    | 直前に実行された Ex コマンド。                                         |
|    "/    | 直前に検索されたパターン。                                             |

- Tips62: レジスタから貼り付け
- Tips63: システムレベルのクリップボードを扱う

挿入モードでの貼り付けとして、`<Ctrl-r>{register}`が紹介されています。  
JIS キーボードであれば左手を多く使用する`<Ctrl-r>"`よりも、`<Ctrl-r>0`の方がおすすめです。  
私は Windows と MacOS で使用するキー配列を分けているので、ときどき混乱します。

本書にも記載がある通り、複数行のテキスト領域を貼り付ける場合には、`p`や`P`による貼り付けに軍配が上がります。  
ケースバイケースで使い分けたほうがよいです。

### 第１１章 マクロ

初めてこの本を読んだ時に最も衝撃を受けた機能がマクロです。  
強力なツールですが、あまり使いこなせておらず、マスターしていく必要があると感じています。

- Tips64: マクロの記録と実行

`q{register}`でマクロの記録を開始し、`q`で記録を終了します。マクロを実行する際は`@{register}`を利用します。  
直前に利用されたマクロは`@@`で繰り返すことができます。キーの押しやすさから、普段使う場合は`qq`が便利です。

- Tips65: 正規化、撃破、中断
- Tips66: 回数を指定してマクロを再生する

マクロを記録する際は、`l`や`h`ではなく、`0`,`w`,`e`,`$`による移動を使うほうが好ましいです。  
すべての行で再利用ができるようにマクロを考えるのもテクニックだと教えてくれています。

ドットの公式では、`;.`を連打する方法を教わりました。  
数回であれば簡単ですが、もっとたくさん(数え切れないほど)実行する場合はちょっとしんどいです。  
そんな時に回数を指定したマクロが便利だと学びました。`qq;.q`のあとに、`11@q`で 11 回繰り返して実行することができます。  
マクロは、 **モーションに失敗したら処理が中断する** ため、正確な数を意識する必要はありません。

- Tips67: 連続する行に対して変更を繰り返す
- Tips69: 複数のファイルにマクロを適用する

ここでは、マクロを直列に実行する方法と、並列に実行する方法について紹介されています。

```
1. one
2. two
3. three
4. four
```

というテキストを、

```
1) One
2) Two
3) Three
4) Four
```

に編集する例が挙げられています。

##### 直列の例

`qa0f.r)w~jq`でマクロを記録して、`3@a`で実行します。  
この方法の特徴としては、2 行目と 3 行目の間に

```
// break up the monotony
```

のようなコメントが入っていた場合、コメント行でマクロが止まることです。  
この場合、4 行目に移動してもう一度マクロを実行する必要があります。

##### 並列の例

`qa0f.r)w~q`でマクロを記録して、`j`で 2 行目に移動し、`VG`で領域を選択します。その後、

```
:'<,'>normal @a
```

を実行します。この方法では、マクロが各行に対して並列に実施されます。

並列に実行するほうが堅牢性が高い一方で、直列に実行するとエラーが可視化できるため、使い分けはケースバイケースです。

- Tips68: マクロにコマンドを追記する
- Tips71: マクロの内容を編集する

ここでは記録済みのマクロを修正する方法が記載されています。  
`:reg [register]`コマンドでマクロの内容を確認することができます。( _register_ は省略可能)

マクロの編集はプレーンテキスト上でおこないます。
そのためにレジスタをドキュメントに貼り付ける際、必ず現在行の下に貼り付けてくれる`:put a`を使うほうが好ましいです。(`"ap`コマンドだと、カーソルの後ろに挿入される場合があります。)

- Tips70: イテレータを評価してリスト中の要素に番号をつける

番号付き箇条書きを作成するのに便利なテクニックが紹介されています。  
`:let i=1`で変数に値を代入した後に、`qaI<Ctrl-r>=i<CR>) <Esc>:let i += 1q`でマクロを記録します。  
記録した行以降の行を`jVG`で移動・選択して、

```
:'<,'>normal @a
```

を実施すれば、各行に番号付き箇条書きが挿入されます。

## 第５部 パターン

### 第１２章 パターンとリテラルのマッチ

Vim の正規表現エンジンは特徴があり、いくつかのパターンスイッチが存在します。  
この章では、それらのパターンがどのように振る舞うのかが紹介されています。

- Tips72: 検索パターンが大文字／小文字を区別するかを制御する

ignorecase, smartcase のオプションを設定することで、グローバルに大文字／小文字の区別を制御できます。  
検索ごとに設定する場合は、\c(区別なし)／\C(区別あり)で制御できます。

- Tips73: 正規表現検索で「\v」パターンスイッチを使う
- Tips74: \V リテラルスイッチを使ってテキストそのものを検索

Vim のパターンスイッチは magic / very magic / nomagic / very nomagic の４種類があります。  
デフォルトは magic 検索ですが、「\v」を利用することで very magic 検索を、「\V」を利用することで very nomagic 検索をおこなえます。  
特に very nomagic 検索はほとんどの特殊文字の意味をエスケープできるので、直接その内容を検索したい時に便利です。

- Tips75: カッコを使って部分マッチをキャプチャする

\\( _word_ \\)でマッチした内容は、\1, \2, ... (\9 が最大)で参照できます。この機能は後述の`:substitute`コマンドで威力を発揮します。

- Tips76: 単語の境界を指定する
- Tips77: マッチ境界を指定する

Vim には境界を意味する幅 0 の要素がいくつか存在します。  
単語の境界を表す「<」と「>」や、マッチの境界を表す「\zs」と「\ze」が比較的使う機能です。

### 第１３章 検索

置換やグローバルコマンドと併せて利用することで非常に強力な機能となる「検索」機能について紹介されています。  
最初から上手くやるのではなく、徐々に複雑なパターンを作り上げればよいことを学びました。

- Tips80: マッチを強調表示する

下記のキーマッピングを設定しておくことで、`<Ctrl-l>`の画面再描画時に検索の強調表示を無効化できるため便利になります。

```
nnoremap <silent> <C-l> :<C-u>nohlsearch<CR><C-l>
```

- Tips81: 実行前に最初にマッチするものをプレビュー

「incsearch」設定によって、検索フィールドの入力途中(`<CR>`を押す前)に最初のマッチを強調表示してくれるようになります。  
この機能のよいところはマッチの存在が確認できるところです。  
単語が確認できたら`<Esc>`を押して思考の流れを止めることなく元のカーソル位置に戻ってくることができます。

- Tips83: 検索のマッチの末尾にカーソルをオフセットする

ここでは検索のマッチング時に、末尾に移動する方法として`/word/e<CR>`が紹介されています。  
このトピックで印象深かったのは「検索を`n`で繰り返すうちに末尾マッチのほうがよいことに気付いた場合、Vim では`//e<CR>`で簡単に変更できる」ということです。

Vim では作業内容をリファクタリングしながら進めていくことが可能です。  
**最初から完璧を求められすぎない** ことが、アジャイル開発的でよいと感じました。

- Tips85: 検索履歴を繰り返しながら、複雑なパターンを作り上げる

冒頭で、

> 正規表現を記述するのは簡単なことではない。最初は間違えるものだ。

と記載されています。  
最初は「マッチの対象を幅広く取り」、「調整」を重ねて目的の形に近づけていく、という考え方はしっくりときました。  
このとき、`/<Up>`や`/<Ctrl-p>`で検索履歴を編集する以外にも、`q/`でコマンドラインウィンドウから変更をおこなう方法が紹介されています。  
※コマンドラインウィンドウはコマンドラインモードから`<Ctrl-f>`で開くこともできます。

### 第１４章 置換

Ex コマンドの中で最も強力なものの１つとして紹介されています。  
私もこれまで単なる検索置換処理だと思っていたので、学ぶことの多い章でした。

- Tips87: 置換コマンド

```
:[range]s[ubstitute]/{pattern}/{string}/[flags]
```

- Tips88: ファイル中のすべてのマッチを検索／置換する
- Tips89: 置換のたびに確認する
- Tips96: 複数ファイル感で検索と置換を行う

よく利用するフラグとして、g/c/n/e が挙げられます。

global の意味は「現在行のなかでグローバル」であり、「%」を置換コマンドの先頭に付加することでファイル全体に適用することができる、と説明されています。  
フラグはパターンにマッチする行に対して機能する( _range_ を指定すれば複数行)ことを認識しました。

- Tips90: 直前の検索パターンを流用する

> パターンを組み立てることと、適切な置換文字列を考えること。この方法を使えば、いつだって、置換コマンドをこれら２つの作業に分割できる。

Tips85 で学んだことが活きてくる Tips です。

検索フィールド( _pattern_ )を空白にすることで、直前の検索を再利用することができます。  
この機能により、`:substitute`コマンド内で正規表現を組み立てる必要がなくなります。

一方で、「シンプルなコマンドだと手順を分ける必要はない」や、「コマンド履歴が分かれてしまう」といったデメリットについても記載されています。  
検索レジスタの貼り付け(`<Ctrl-r>/`)を利用すると、直前の検索を利用しつつ、ワンライナーでコマンドを実行できます。

- Tips91: レジスタの内容を使って置換を行う

コマンドラインで値を渡す`<Ctrl-r>{register}`はこれまでにも利用してきましたが、`\={Vim Script}`の存在は初めて知りました。  
`let`コマンドでレジスタに値をセットし、`@{register}`として参照することで利用ができます。

使い方の例は以下のとおりです。

```
:let @/='old_text'
:let @a='new_text'
:%s//\=@a/g
```

- Tips92: 直前の置換コマンドを繰り返す

行単位の置換をファイル全体に対して繰り返す場合には`g&`が利用できます。  
`[range]&&`でフラグ付きの`:s`コマンドを範囲指定で流用することも可能です。

- Tips94: 置換時に算術計算をおこなう

submatch()関数を利用した置換方法が紹介されています。  
マッチした数字にすべて 1 を加算したい場合、`:s/\d\+/\=submatch(0)+1/g`で実現可能です。

### 第１５章 グローバルコマンド

置換コマンドはこれまでもよく利用してきましたが、グローバルコマンドはあまり使ってはいませんでした。  
この章を通じて、グローバルコマンドがいかに強力なツールであるかを理解しました。  
ドットの公式やマクロと同様に、繰り返し作業に向いた機能として紹介されています。

- Tips97: グローバルコマンドとは
- Tips98: パターンを含む行を削除する

```
:[range]g[lobal]/{pattern}/[range][cmd]
```

グローバルコマンドでは、パターンにマッチした各業に Ex コマンドを利用できます。

このとき、グローバルコマンドのデフォルトの範囲はファイル全体(%)です。  
Ex コマンドのデフォルトの範囲はカーソル行(.)なので、この部分が大きく異なります。  
また、 _cmd_ を省略した場合には`:print`がデフォルトで使用されます。

`:global!`もしくは`:v[global]`を使用することで、マッチしない各行に対して _cmd_ を実行することが可能です。

`:g/re/p`が grep(Global Regular Expression Print)の起源というコラムも紹介されています。  
マッチする行を削除する場合は`:g/re/d`です。

- Tips100: CSS ファイル中のルールのプロパティをアルファベット順に並び替える

```css
html {
  margin: 0;
  padding: 0;
  border: 0;
  font-size: 100%;
  font: inherit;
  vertical-align: baseline;
}

body {
  line-height: 1.5;
  color: black;
  background: white;
}
```

各ルールのプロパティをアルファベット順にソートしたい場合に、範囲指定のコマンドが利用できます。

```
:g/{/ .+1,/}/-1 sort
```

を実行することで、以下のような結果となります。

```css
html {
  border: 0;
  font-size: 100%;
  font: inherit;
  margin: 0;
  padding: 0;
  vertical-align: baseline;
}

body {
  background: white;
  color: black;
  line-height: 1.5;
}
```

`:global`コマンドは、以下の形で用いることができます。

```
:g/{start}/[sil] .,{finish} [cmd]
```

大量の行にマッチする場合に、コマンドの前に`:silent`を前置きすることでメッセージのエコーを抑制できるので便利です。  
※メッセージがエコーされるコマンドとされないコマンドがあります。

## 第６部 ツール

### 第１６章 ctags を使ってソースコードのインデックスを作成し、ナビゲーションを行う

ctags は、プログラミングコードを編集する際に便利のようです。  
関数やクラスの宣言元にジャンプして作業ができるみたいですが、今はまだ使う機会が少なそうなので流して読みました。

### 第１７章 quickfix リストを使って、コードのコンパイルとエラー発生箇所への移動を行う

この章では quickfix リストの説明がおこなわれています。  
`:make`は利用したことがありませんが、外部ツールを Vim に組み込むための核となる quickfix リストの機能は知っておく価値があります。

- Tips105: quickfix リストをブラウズする

quickfix リストには、１つ以上のアドレス群が保持されます。  
`:make`の際のエラーであったり、`:grep`の際のマッチであったりします。

quickfix リストをナビゲーションするためのコマンドを以下に記載します。

| コマンド                | 動作                                         |
| :---------------------- | :------------------------------------------- |
| `:cn[ext]`/`:cp[rev]`   | 次／前の要素にジャンプ                       |
| `:cfir[st]`/`:cla[st]`  | 最初／最後の要素にジャンプ                   |
| `:cnf[ile]`/`:cpf[ile]` | 次／前のファイルの最初／最後の要素にジャンプ |
| `:cc N`                 | N 番目の要素にジャンプ                       |
| `:cope[n]`/`:ccl[ose]`  | quickfix ウィンドウをオープン／クローズ      |

この章では「ロケーションリスト」についても紹介されていましたが、まだ quickfix リストにも慣れていないため、今回は流して読みました。

### 第１８章 grep/vimgrep などを使ってプロジェクト全体を検索する

Vim の検索コマンドは、単一のファイルに対して効力を発揮します。  
一方で、プロジェクト全体に対して検索をおこないたいケースも存在します。

この章では、Vim を抜けずに Unix ツールの grep を利用する方法や、その代替となる vimgrep について紹介されています。

- Tips108: Vim を抜けずに grep を呼び出す

外部プログラムの grep を呼び出すコマンドがあり、それが`:grep {search} {file} ...`です。  
このコマンドは自動的に-n フラグを含んでいるため、マッチした行が quickfix リストに格納されます。

- Tips110: Vim の内部検索エンジンを使って grep する

```
:vim[grep][!] /{pattern}/[g][j] {file} ...
```

1 行に複数のマッチがある場合に、g フラグによって挙動が異なります。  
マッチ後のジャンプを制御するのが j フラグです。

`:vimgrep`の長所は、Vim の検索パターンと同じ表現を利用できることです。  
そのため、`<Ctrl-r>/`で検索レジスタを貼り付けることが可能です。

気をつける必要があるのは、パターンフィールドを空`//`にすると、検索対象となるすべてのファイルのすべての行にマッチすることです。  
この点が`:substitute`や`:global`との違いになります。

また、`:vimgrep`は`:grep`と比べると処理に時間がかかるのも特徴です。

### 第１９章 ダイヤル X を廻せ！自動補完だ

オートコンプリート機能は、編集作業の効率化に欠かせないものです。  
Vim のオートコンプリートをフル活用するには、「関連する候補を呼び出す方法」と「リストから適切な単語を選択する方法」を理解する必要がある、と記載されています。

- Tips111: Vim のキーワード自動補完機能とは
- Tips115: 行を丸ごと自動補完
- Tips116: ファイル名の自動補完
- Tips117: コンテキストにあわせて自動補完を行う

自動補完機能は、挿入モードで`<Ctrl-p>`もしくは`<Ctrl-n>`を押すことにより起動されます。  
ここでは汎用の自動補完以外にいくつかのバリエーションが紹介されています。

私的に有用だと感じたものを抜粋します。

| コマンド           | 補完の種類                 |
| :----------------- | :------------------------- |
| `<Ctrl-x><Ctrl-n>` | 現在のバッファのキーワード |
| `<Ctrl-x><Ctrl-l>` | 行全体を補完               |
| `<Ctrl-x><Ctrl-f>` | ファイル名を補完           |
| `<Ctrl-x><Ctrl-o>` | オムニ補完                 |

行の丸ごと補完機能(`<Ctrl-x><Ctrl-l>`)は、他の行の編集内容を再利用できるので便利です。

オムニ補完では、カーソル位置のコンテキストに合わせた候補が表示されます。  
プログラミング言語ごとのサポートはさまざまなので、必要に応じてプログインを拡張するとよい、と書かれています。

- Tips112: 自動補完のポップアップメニューを操作する

単語リストの選択は`<Ctrl-n>`/`<Ctrl-p>`、もしくはカーソルキーの`<Down>`/`<Up>`でおこないます。

`<Ctrl-n>`/`<Ctrl-p>`は、単語選択時にテキストが自動挿入されるため`<CR>`や`<Ctrl-y>`を押す必要がありません。  
加えて、ホームポジションから指を動かさなくても利用できるのでおすすめです。

自動補完メニューを消したいときは`<Ctrl-e>`で終了することができます。

### 第２０章 Vim のスペルチェッカを使ってタイプミスを発見、修正する

タイプミスを完全にゼロにすることは困難だと思います。  
スペルチェッカを利用すると、スペルミスにジャンプして修正候補を表示してもらうことができます。

- Tips118: 作業結果にスペルチェックをかけてみよう

組み込みのスペルチェッカを起動するコマンドは`:set spell`です。  
フラグが付いた単語間は`[s`/`]s`でジャンプできます。  
単語の上にカーソルがある時は、`z=`コマンドで修正候補のリストを表示することが可能です。

- Tips121: スペルミスを挿入モードで修正する

挿入モードで`<Ctrl-x>s`もしくは`<Ctrl-x><Ctrl-s>`を押すと、カーソル位置から戻りながらエラーをスキャンします。(`:set spell`は必要です)  
スペルミスが見つかった場合、修正候補から単語リストを作成してポップアップメニューが表示されます。  
挿入モードでは行末にカーソルが存在することが大半なので、このテクニックは非常に便利です。

### 第２１章 それからどうする

本書の最終章です。

本書では Vim の基本的な使い方を学びました。  
これから、切れ味を鋭くしていく(刃を研ぐ)ことでテキスト編集の効率は何倍にもなります。

使い方を「理解し」、刃を「磨く」ことの大切さを再認識させられる章です。

### 付録Ａ 自分の好みに合わせて Vim をカスタマイズする

Vim のカスタマイズ方法が紹介されています。

vimrc を修正した場合には、`:source`コマンドで即座に反映することができます。

# おわりに

Vim の機能を知ったからといって、劇的に生産性が上がるわけではありません。  
学んだ知識を実践し、活用していくことが大事だと考えています。

この本には、Vim を扱う上での考え方から非常に強力な機能まで、さまざまな Tips が記載されています。  
本書に記載されているように「のこぎりの使い方」は知りました。  
あとは、「切れ味を鋭くし」て「使う」だけです。

Vim には他にも便利な機能がたくさんあるので、これからも学びつづけ、使いこなせるようになっていきたいと思います。
